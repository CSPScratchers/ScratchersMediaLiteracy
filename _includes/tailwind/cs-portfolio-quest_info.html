<!-- Prerequisites links (unchanged) -->
{% if page.lxdData.Prequisites %}
<div class="mb-8">
  <ul class="flex flex-wrap gap-4 justify-center">
    {% for prereq in page.lxdData.Prequisites %}
      <li><a href="{{ site.baseurl}}{{ prereq.link }}" class="iridescent flex-1 text-white text-white text-center py-2 rounded-lg font-semibold transition">{{ prereq.title }}</a></li>
    {% endfor %}
  </ul>
</div>
{% endif %}

<!-- Progress Overview (unchanged styling) -->
<div class="mb-8 text-center">
  <div class="bg-gray-800 rounded-lg p-6 max-w-2xl mx-auto">
    <h3 class="text-white font-semibold mb-3">Learning Progress</h3>
    <div class="module-progress">
      <div class="progress-bar" id="overall-progress"></div>
    </div>
    <p class="text-gray-300 text-sm" id="progress-text">Complete modules C1-C6 to earn your certificate</p>
  </div>
</div>

<div class="container mx-auto px-4 py-8 bg-black/5 backdrop-blur-sm rounded-xl relative">
  <div class="absolute -inset-1 bg-gradient-to-r from-indigo-200 via-purple-200 to-pink-200 rounded-xl opacity-40 blur-xl"></div>
  <div class="relative z-10">

    <!-- Title and Description (unchanged) -->
    <div class="text-center mb-12">
      <h2 class="text-4xl md:text-5xl font-bold text-white mb-4">{{ page.lxdData.Title }}</h2>
      <p class="text-xl text-gray-300 max-w-4xl mx-auto">{{ page.lxdData.Description }}</p>
    </div>

    <!-- Module Cards Grid (unchanged styling) -->
    <div class="grid grid-cols-1 md:grid-cols-1 lg:grid-cols-2 xl:grid-cols-2 gap-6 mb-12">
      {% for topic in page.lxdData.Topics %}
        <div class="bg-gray-800 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 overflow-hidden group transform hover:-translate-y-2 card-hover-effects" data-module="c{{ topic.Level }}">
          
          <!-- Module Status Badge -->
          <div class="module-status">
            <span class="status-badge status-locked module-badge">Locked</span>
          </div>
          
          <!-- Image with Play Overlay -->
          <div class="relative h-40 overflow-hidden bg-gradient-to-br from-gray-700 to-gray-900 mb-4">
            <a href="{{ topic.Video }}" class="block w-full h-full group video-link">
              <img src="{{ site.baseurl }}{{ topic.Image }}" alt="{{ topic.Alt }}" class="w-full h-full object-contain transition-all duration-300 group-hover:scale-110">
              <div class="absolute inset-0 bg-black bg-opacity-50 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center">
                <div class="iridescent bg-white bg-opacity-90 rounded-full p-3">
                  <svg class="w-8 h-8 text-green-600" fill="currentColor" viewBox="0 0 20 20"><path d="M8 5v10l8-5z"/></svg>
                </div>
              </div>
            </a>
          </div>
          
          <!-- Module Progress Bar -->
          <div class="px-6">
            <div class="module-progress">
              <div class="progress-bar module-progress-bar"></div>
            </div>
          </div>
          
          <div class="p-6 pt-2">
            <h3 class="text-xl font-bold text-white mb-1">{{ topic.Title }}</h3>
            <p class="text-sm text-gray-400 mb-2">{{ topic.Genre }} | Level: {{ topic.Level }}</p>
            <p class="text-gray-300 text-sm mb-4">{{ topic.Description }}</p>
            <div class="mb-4">
              <span class="text-sm font-semibold text-gray-200">Categories:</span>
              <div class="flex flex-wrap gap-1 mt-1">
                {% for cat in topic.Categories %}
                  <span class="bg-blue-900 text-blue-200 text-xs px-2 py-1 rounded-full">{{ cat }}</span>
                {% endfor %}
              </div>
            </div>
            <div class="flex gap-2">
              <a href="{{ site.baseurl }}{{ topic.Lessons }}" class="iridescent flex-1 text-white text-center py-2 rounded-lg font-semibold transition lesson-link">Start Module</a>
              <a href="{{ topic.Video }}" class="iridescent flex-1 text-white text-center py-2 rounded-lg font-semibold transition video-link">Watch Video</a>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>

  </div>
</div>

<!-- Quest Hub Locking/Progress -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const NS = "cs-portfolio-quest";
  const LESSON_COUNT = 6;

  // Helpers that operate on SLUGS (e.g., "frontend", "ai-usage")
  const key = (slug,n) => `${NS}:${slug}:lesson:${n}`;
  const lessonDone = (slug,n) => localStorage.getItem(key(slug,n)) === "done";
  const moduleCountDone = (slug) => { let c=0; for (let i=1;i<=LESSON_COUNT;i++) if (lessonDone(slug,i)) c++; return c; };
  const moduleCompleted = (slug) => moduleCountDone(slug) === LESSON_COUNT;

  // Find all module cards in page order and extract their mini-quest slug
  const cards = Array.from(document.querySelectorAll('[data-module]'));
  function getSlugFromCard(card) {
    // prefer an explicit data attribute if you decide to add one later:
    // const explicit = card.dataset.slug; if (explicit) return explicit;
    const link = card.querySelector(".lesson-link"); // points to the mini-quest landing page
    if (!link) return null;
    try {
      const url = new URL(link.getAttribute("href"), window.location.origin);
      // expected path: /cs-portfolio-quest/<slug>/...
      const parts = url.pathname.split("/").filter(Boolean);
      const i = parts.indexOf("cs-portfolio-quest");
      return (i >= 0 && parts[i+1]) ? parts[i+1] : null;
    } catch { return null; }
  }

  const modules = cards.map(card => ({
    card,
    slug: getSlugFromCard(card)
  })).filter(m => !!m.slug);

  // Iterate in visual order; unlock module N when module N-1 is completed.
  let completedModules = 0;

  modules.forEach((m, idx) => {
    const { card, slug } = m;
    const badge = card.querySelector(".module-badge");
    const bar   = card.querySelector(".module-progress-bar");
    const link  = card.querySelector(".lesson-link");

    const doneCnt   = moduleCountDone(slug);
    const completed = doneCnt === LESSON_COUNT;
    const available = idx === 0 ? true : moduleCompleted(modules[idx-1].slug);

    // progress bar inside card
    if (bar) {
      const pct = Math.round((doneCnt/LESSON_COUNT)*100);
      bar.style.width = pct + "%";
      bar.className = "progress-bar module-progress-bar" + (completed ? " completed" : doneCnt ? " partial" : "");
    }

    // badge
    if (badge) {
      if (completed) { badge.textContent = "Completed"; badge.className = "status-badge status-completed module-badge"; completedModules++; }
      else if (available) { badge.textContent = "Available"; badge.className = "status-badge status-current module-badge"; }
      else { badge.textContent = "Locked"; badge.className = "status-badge status-locked module-badge"; }
    }

    // CTA
    if (link) {
      if (available) { link.textContent = completed ? "Review" : "Start Module"; link.style.opacity=""; link.style.pointerEvents=""; link.setAttribute("aria-disabled","false"); }
      else { link.textContent = "Locked"; link.style.opacity="0.5"; link.style.pointerEvents="none"; link.setAttribute("aria-disabled","true"); }
    }
  });

  // overall progress bar/text at top of page
  const overall = document.getElementById("overall-progress");
  const progressText = document.getElementById("progress-text");
  if (overall) overall.style.width = ((completedModules / modules.length)*100) + "%";
  if (progressText) {
    progressText.textContent = completedModules === modules.length
      ? "ðŸŽ‰ Congratulations! All modules completed!"
      : `${completedModules}/${modules.length} modules completed`;
  }
});
</script>
